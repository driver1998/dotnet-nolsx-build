name: Build .NET SDK

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'dotnet VMR branch name'
        required: true
        type: string
        default: main-9.x-loong

jobs:
  run:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          - rid: linux-loongarch64
            container: mcr.microsoft.com/dotnet-buildtools/prereqs:azurelinux-3.0-net10.0-cross-loongarch64
            osName: linux
          - rid: linux-musl-loongarch64
            container: mcr.microsoft.com/dotnet-buildtools/prereqs:azurelinux-3.0-net10.0-cross-loongarch64-musl
            osName: linux-musl

    steps:

    - name: Maximize build space
      uses: AdityaGarg8/remove-unwanted-software@v4.1
      with:
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-cached-tools: 'true'        

    - name: Clone repository
      run: |
        git clone --depth 1 -b ${{ inputs.branch }} https://github.com/driver1998/dotnet-nolsx

    - name: Build
      run: |
        docker run --platform linux/amd64 --rm -v${{ github.workspace }}/dotnet-nolsx:/dotnet -w /dotnet -e ROOTFS_DIR=/crossrootfs/loongarch64 \
          ${{ matrix.container }} \
          sh -c '
            pushd src/runtime &&
            ./build.sh -c Release --cross --arch loongarch64 --os ${{ matrix.osName }} &&
            popd &&
            pushd src/aspnetcore &&
            sed -i "s|\$(BaseIntermediateOutputPath)\$(DotNetRuntimeArchiveFileName)|/dotnet/src/runtime/artifacts/packages/Release/Shipping/\$(DotNetRuntimeArchiveFileName)|" src/Framework/App.Runtime/src/Microsoft.AspNetCore.App.Runtime.csproj && 
            ./eng/build.sh --pack --ci -c Release -arch loongarch64 --os-name ${{ matrix.osName }}
          '

    - name: List assets directory
      run: |
        find "${{ github.workspace }}/dotnet-nolsx/src/runtime/artifacts/packages/Release/NonShipping/"
        find "${{ github.workspace }}/dotnet-nolsx/src/runtime/artifacts/packages/Release/Shipping/"
        find "${{ github.workspace }}/dotnet-nolsx/src/aspnetcore/artifacts/packages/Release/NonShipping/"
        find "${{ github.workspace }}/dotnet-nolsx/src/aspnetcore/artifacts/packages/Release/Shipping/"

    - name: Upload .NET
      uses: actions/upload-artifact@v4
      with:
        name: dotnet-sdk-${{ matrix.rid }}
        path: |
          ${{ github.workspace }}/dotnet-nolsx/src/runtime/artifacts/packages/Release/Shipping/*
          ${{ github.workspace }}/dotnet-nolsx/src/runtime/artifacts/packages/Release/NonShipping/*
          ${{ github.workspace }}/dotnet-nolsx/src/aspnetcore/artifacts/packages/Release/Shipping/*
          ${{ github.workspace }}/dotnet-nolsx/src/aspnetcore/artifacts/packages/Release/NonShipping/*

